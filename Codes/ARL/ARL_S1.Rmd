---
title: "ARL_S1"
author: "Hadi"
date: "2023-12-05"
output: html_document
---

load libraries
```{r}
library(arules)
library(arulesViz)
library(knitr)
library(plyr)
library(dplyr)
library(RColorBrewer)
library(stringr)
library(writexl)
library(feather)
library(xtable)
```

Load datasets
```{r}
MLFeat <- 
  read_excel(path ="C:/.../Features.xlsx", na = c ("NA", "#N/A N/A", "#N/A Field Not Applicable", "#N/A Invalid Security"))



California_20_23 <- read_feather("C:.../California_20_23.feather")


```

Add median (and mean) of S1  by year and bond

```{r}
s
ARL <- California_20_23 %>% group_by(ID_CUSIP, year) %>% dplyr::summarise(Med_S1 = median(S1)
                                                                    , Mea_S1 = mean(S1))

```

Label Spread based on their sign
```{r}



ARL$Med_SL <- 0
ARL$Mea_SL <- 0


#Median

for (i in 1:nrow(ARL)){
  if (ARL$Med_S1[i] > 0){
    ARL$Med_SL[i] <- "S+"
  } else if (ARL$Med_S1[i] < 0){
    ARL$Med_SL[i] <- "S-"
  } else if (ARL$Med_S1[i] == 0){
    ARL$Med_SL[i] <- "S0"
  }
} 


#Mean

for (i in 1:nrow(ARL)){
  if (ARL$Mea_S1[i] > 0){
    ARL$Mea_SL[i] <- "S+"
  } else if (ARL$Mea_S1[i] < 0){
    ARL$Mea_SL[i] <- "S-"
  } else if (ARL$Mea_S1[i] == 0){
    ARL$Mea_SL[i] <- "S0"
  }
} 

```



Add features
```{r}
ARL <- merge(ARL, MLFeat, by = "ID_CUSIP")

```


labeling numerical features
```{r}

#replace labels  for Callability

for (i in 1:nrow(ARL)) {
  if (ARL$CALLABLE[i] == "FALSE") {
    ARL$CALLABLE[i] <- "Non-callable"
  } else {
    ARL$CALLABLE[i] <- "Callable"
  }
}




#SELF_REPRTD_GREEN_INSTR_INDCTR

ARL$SELF_REPRTD_GREEN_INSTR_INDCTR[ARL$SELF_REPRTD_GREEN_INSTR_INDCTR == "TRUE"]<-
  "YES"

#Coupon rate
cpn_intervals <- cut(ARL$CPN, breaks = c(0, 2.99, 4.999, 15), labels = c("0_3(%)", "3_5(%)", "5_8.5(%)"))

ARL <- ARL %>% mutate(CPN_Group = cpn_intervals)

#SPREAD_AT_ISSUANCE_TO_WORST
Sp_at_iss_intervals <- cut(ARL$SPREAD_AT_ISSUANCE_TO_WORST,
                           breaks = c(quantile(ARL$SPREAD_AT_ISSUANCE_TO_WORST, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c("Less than 17", "17_57", "57_100", "Higher than 100"), include.lowest = TRUE)

ARL <- ARL %>% mutate(S_AT_Iss = Sp_at_iss_intervals)


#DUR_ADJ_MID
DUR_ADJ_MID_intervals <- cut(ARL$DUR_ADJ_MID,
                           breaks = c(quantile(ARL$DUR_ADJ_MID, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c(" Less than 2.8", "2.8_4.8", "4.8_7", "Higher than 7"), include.lowest = TRUE)

ARL <- ARL %>% mutate(DAM = DUR_ADJ_MID_intervals)



#DUR_MID
DUR_MID_intervals <- cut(ARL$DUR_MID,
                           breaks = c(quantile(ARL$DUR_MID, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c("Less than 2.9", "2.9_4.9", "4.9_7.3", " Higher than 7.3"), include.lowest = TRUE)

ARL <- ARL %>% mutate(DM = DUR_MID_intervals)



#	YIELD_ON_ISSUE_DATE
Y_on_Iss_Date_intervals <- cut(ARL$YIELD_ON_ISSUE_DATE,
                           breaks = c(quantile(ARL$YIELD_ON_ISSUE_DATE, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c(" Less than 1.7", "1.7_2.4", "2.4_3.2", "Higher than 3.2"), include.lowest = TRUE)

ARL <- ARL %>% mutate(Y_OID = Y_on_Iss_Date_intervals)




#	ISSUE_PX

#1-labeling price at issuance

ARL <- ARL %>%
  mutate(
    Iss_pri._spread = case_when(
      is.na(ISSUE_PX) ~ NA_character_,
      ISSUE_PX == 100 ~ "At Par",
      ISSUE_PX < 100 ~ "At Discount",
      ISSUE_PX > 100 ~ "At Premium"
    )
  )

#2-Labeling the quartiles of the discount or premium  

# ARL <- ARL %>%
#   mutate(
#     Iss._pri_int = case_when(
#       is.na(ISSUE_PX) ~ NA_character_,
#       ISSUE_PX == 100 ~ "Par (100)",
#       ISSUE_PX < 100 ~ paste0("Disc.[74.5_100)" ),
#       ISSUE_PX > 100 ~ paste0("Prem. ", cut(ifelse(ISSUE_PX > 100, ISSUE_PX, NA), breaks = 4))
#     )
#   )
# 
# ARL$Iss._pri_int <- str_replace_all(ARL$Iss._pri_int, ",", "-")

#AMT_ISSUED
ARL$log_AMT_ISSUED <- log(ARL$AMT_ISSUED)

Amt_issued_intervals <- cut(ARL$log_AMT_ISSUED,
                           breaks = c(quantile(ARL$log_AMT_ISSUED, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c("Less than 14", "14_15", "15_16", "Higher than 16"), include.lowest = TRUE)

ARL <- ARL %>% mutate(Amt_iss_int = Amt_issued_intervals)

#MUNI_ISSUE_SIZE
ARL$log_MUNI_ISSUE_SIZE <- log(ARL$MUNI_ISSUE_SIZE)

MUNI_ISSUE_SIZE_intervals <- cut(ARL$log_MUNI_ISSUE_SIZE,
                           breaks = c(quantile(ARL$log_MUNI_ISSUE_SIZE, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c("Less than 17", "17_18.7", "18.7_19.5", "Higher than 19.5"), include.lowest = TRUE)

ARL <- ARL %>% mutate(MUNI_ISSUE_SIZE_int = MUNI_ISSUE_SIZE_intervals)


#SHORT_AND_LONG_TERM_DEBT
ARL$Log_DEBT <- log(ARL$SHORT_AND_LONG_TERM_DEBT)

Debt_intervals <- cut(ARL$Log_DEBT,
                           breaks = c(quantile(ARL$Log_DEBT, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c("Less than 5", "5-6.5", "6.5_8", "Higher than 8"), include.lowest = TRUE)

ARL <- ARL %>% mutate(S_L_DEBT = Debt_intervals)


#8.	SALES_REV_TURN
ARL$Log_Sale_Turn <- log(ARL$SALES_REV_TURN)

Sale_intervals <- cut(ARL$Log_Sale_Turn,
                           breaks = c(quantile(ARL$Log_Sale_Turn, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c("Less than 3.5", "3.5-4.6", "4.6_6.5", "Higher than 8.5"), include.lowest = TRUE)

ARL <- ARL %>% mutate(SALES_REV_TURN_int = Sale_intervals)



#MTY-YEARS

MTY_YEARS_intervals <- cut(ARL$`MTY-YEARS`,
                           breaks = c(quantile(ARL$`MTY-YEARS`, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c(" Less than 8", "8_12.3", "12.3_17", "Higher than 17"), include.lowest = TRUE)

ARL <- ARL %>% mutate(MTY_YEARS_int = MTY_YEARS_intervals)

#ISSUE_DT and Maturity
ARL$Y_l_day <- as.Date(paste(ARL$year, "-12-31", sep = ""), format = "%Y-%m-%d")


for (i in 1:nrow(ARL)){
  ARL$Active_years[i] <- yearFraction(ymd(ARL$ISSUE_DT[i]) 
                                   , ymd(ARL$Y_l_day[i]), dayCounters = 12)
  ARL$years_to_maturity[i] <- yearFraction(ymd(ARL$Y_l_day[i]) 
                                   , ymd(ARL$MATURITY[i]), dayCounters = 12)
  
}

active_years_interval <- cut(ARL$Active_years,
                           breaks = c(quantile(ARL$Active_years, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c(" Less than 1.1", "1.1_2.3", "2.3_4.1", "Higher than 4.1"), include.lowest = TRUE)

ARL <- ARL %>% mutate(Active_years_int = active_years_interval)


years_to_maturity_interval <- cut(ARL$years_to_maturity,
                           breaks = c(quantile(ARL$years_to_maturity, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c(" Less than 4.7", "4.7_9.4", "9.4_14.4", "Higher than 14.4"), include.lowest = TRUE)

ARL <- ARL %>% mutate(years_to_maturity_int = years_to_maturity_interval)




```

label missing with char "NA"
```{r}


ARL$BB_COMPOSITE[is.na(ARL$BB_COMPOSITE)] <- "Not_Rated"
ARL$SELF_REPRTD_GREEN_INSTR_INDCTR[is.na(ARL$SELF_REPRTD_GREEN_INSTR_INDCTR)] <- "Not labelled"
ARL$RTG_FITCH[is.na(ARL$RTG_FITCH)] <- "Not_Rated"
ARL$RTG_FITCH_LONG[is.na(ARL$RTG_FITCH_LONG)] <- "Not_Rated"

ARL$S_AT_Iss <- as.character(ARL$S_AT_Iss)
ARL$S_AT_Iss[is.na(ARL$S_AT_Iss)] <- "NA"

ARL$S_AT_Iss <- as.character(ARL$S_AT_Iss)
ARL$S_AT_Iss[is.na(ARL$S_AT_Iss)] <- "NA"

ARL$DAM <- as.character(ARL$DAM)
ARL$DAM[is.na(ARL$DAM)] <- "NA"


ARL$DM <- as.character(ARL$DM)
ARL$DM[is.na(ARL$DM)] <- "NA"



ARL$Y_OID <- as.character(ARL$Y_OID)
ARL$Y_OID[is.na(ARL$Y_OID)] <- "NA"



ARL$Iss_pri._spread <- as.character(ARL$Iss_pri._spread)
ARL$Iss_pri._spread[is.na(ARL$Iss_pri._spread)] <- "NA"




# ARL$Iss._pri_int <- as.character(ARL$Iss._pri_int)
# ARL$Iss._pri_int[is.na(ARL$Iss._pri_int)] <- "NA"




ARL$Amt_iss_int <- as.character(ARL$Amt_iss_int)
ARL$Amt_iss_int[is.na(ARL$Amt_iss_int)] <- "NA"





ARL$MUNI_ISSUE_SIZE_int <- as.character(ARL$MUNI_ISSUE_SIZE_int)
ARL$MUNI_ISSUE_SIZE_int[is.na(ARL$MUNI_ISSUE_SIZE_int)] <- "NA"


ARL$MTY_YEARS_int <- as.character(ARL$MTY_YEARS_int)
ARL$MTY_YEARS_int[is.na(ARL$MTY_YEARS_int)] <- "NA"




ARL$Active_years_int <- as.character(ARL$Active_years_int)
ARL$Active_years_int[is.na(ARL$Active_years_int)] <- "NA"

ARL$years_to_maturity_int <- as.character(ARL$years_to_maturity_int)
ARL$years_to_maturity_int[is.na(ARL$years_to_maturity_int)] <- "NA"


ARL$S_L_DEBT <- as.character(ARL$S_L_DEBT)
ARL$S_L_DEBT[is.na(ARL$S_L_DEBT)] <- "NA"

ARL$SALES_REV_TURN_int <- as.character(ARL$SALES_REV_TURN_int)
ARL$SALES_REV_TURN_int[is.na(ARL$SALES_REV_TURN_int)] <- "NA"

```


Add prefix for features
```{r}
ARL$BB_COMPOSITE <- paste("BB_rating", ARL$BB_COMPOSITE, sep = " : ")

ARL$MUNI_TAX_PROV <- paste("Tax", ARL$MUNI_TAX_PROV, sep = " : ")

ARL$CPN_TYP <- paste("CPN TYP", ARL$CPN_TYP, sep = " : ")

ARL$CPN_Group <- paste("CPN", ARL$CPN_Group, sep = " : ")

ARL$MARKET_ISSUE <- paste("Market", ARL$MARKET_ISSUE, sep = " : ")

ARL$CALLABLE <- paste("Call", ARL$CALLABLE, sep = " : ")

ARL$MUNI_PURPOSE <- paste("UOP", ARL$MUNI_PURPOSE, sep = " : ")

ARL$FINANCING_TYPE <- paste("FIN. TYP", ARL$FINANCING_TYPE, sep = " : ")

ARL$ISSUER_BULK <- paste("Issuer Name", ARL$ISSUER_BULK, sep = " : ")

ARL$MUNI_LONG_INDUSTRY_TYP <- paste("Issuer Sector", 
                                         ARL$MUNI_LONG_INDUSTRY_TYP, sep = " : ")
ARL$RTG_FITCH_LONG <- paste("RTG Long Rating", 
                                         ARL$RTG_FITCH_LONG, sep = " : ")
ARL$RTG_FITCH <- paste("RTG Rating", 
                                         ARL$RTG_FITCH, sep = " : ")
ARL$S_AT_Iss <- paste("S OID", 
                                         ARL$S_AT_Iss, sep = " : ")
ARL$DAM <- paste("DU_Adj_MID", 
                                         ARL$DAM, sep = " : ")
ARL$DM <- paste("DU_MID", 
                                         ARL$DM, sep = " : ")
ARL$Y_OID <- paste("Y_OID", 
                                         ARL$Y_OID, sep = " : ")

ARL$Iss_pri._spread <- paste("Pricing TYP", 
                                         ARL$Iss_pri._spread, sep = " : ")

# ARL$Iss._pri_int <- paste("Issue Price Interval", ARL$Iss._pri_int, sep = " : ")

ARL$Amt_iss_int <- paste("Issued Amt", 
                                         ARL$Amt_iss_int, sep = " : ")

ARL$MUNI_ISSUE_SIZE_int <- paste("Muni Issued Size", 
                                         ARL$MUNI_ISSUE_SIZE_int, sep = " : ")

ARL$MTY_YEARS_int <- paste("Maturity OID", 
                                         ARL$MTY_YEARS_int, sep = " : ")
ARL$SELF_REPRTD_GREEN_INSTR_INDCTR <- 
  paste("Self Rep. Gr.",  ARL$SELF_REPRTD_GREEN_INSTR_INDCTR, sep = " : ")

ARL$S_L_DEBT <- paste("Debt",  ARL$S_L_DEBT, sep = " : ")

ARL$SALES_REV_TURN_int <- paste("SALES REV",  ARL$SALES_REV_TURN_int, sep = " : ")

ARL$Active_years_int <- paste("Active years",  ARL$Active_years_int, sep = " : ")

ARL$years_to_maturity_int <- paste("R Ys to Maturity",  ARL$years_to_maturity_int, sep = " : ")
```


Remove redundant features
```{r}


ARL_final_feat <- 
  ARL %>% select(!(c(Med_S1 ,CPN_TYP, CRNCY, MAKE_WHOLE_CALL_TYPE,MUNI_FORM, SUPER_SINKER,
                                  ID_CUSIP, Mea_S1,Mea_SL, CPN, CPN_TYP,CPN_FREQ,
                                 CRNCY, ISSUE_DT, MATURITY,
                             SPREAD_AT_ISSUANCE_TO_WORST, DUR_ADJ_MID, 
                     DUR_MID,ISSUE_PX, YIELD_ON_ISSUE_DATE, AMT_ISSUED,
                     MUNI_ISSUE_SIZE, IS_SUBORDINATED, 
                     SALES_REV_TURN, log_AMT_ISSUED, log_MUNI_ISSUE_SIZE,
                     SHORT_AND_LONG_TERM_DEBT, `MTY-YEARS`, `State Code`, Region, Y_l_day,
                     Active_years, years_to_maturity, Log_DEBT, Log_Sale_Turn, S_L_DEBT,
                     SALES_REV_TURN_int, RTG_FITCH_LONG, RTG_FITCH,DM)))

```



subset dataset for each year
```{r}
# ARL_2016 <- ARL_final_feat %>%  filter(year == 2016) %>% select(!c(year))
# ARL_2017 <- ARL_final_feat %>%  filter(year == 2017) %>% select(!c(year))
# ARL_2018 <- ARL_final_feat %>%  filter(year == 2018) %>% select(!c(year))
# ARL_2019 <- ARL_final_feat %>%  filter(year == 2019) %>% select(!c(year))
ARL_2020 <- ARL_final_feat %>%  filter(year == 2020) %>% select(!c(year))
ARL_2021 <- ARL_final_feat %>%  filter(year == 2021) %>% select(!c(year))
ARL_2022 <- ARL_final_feat %>%  filter(year == 2022) %>% select(!c(year))
ARL_2023 <- ARL_final_feat %>%  filter(year == 2023) %>% select(!c(year))
ARL_total <- ARL_final_feat %>% select(!c(year))

```


Remove missing values
```{r}
ARL_2020 <- ARL_2020[complete.cases(ARL_2020),]
ARL_2021 <- ARL_2021[complete.cases(ARL_2021),]
ARL_2022 <- ARL_2022[complete.cases(ARL_2022),]
ARL_2023 <- ARL_2023[complete.cases(ARL_2023),]
ARL_total <- ARL_total[complete.cases(ARL_total),]

```


Convert all features to factors
```{r}
ARL_2020 <-ARL_2020 %>%  mutate_all(as.factor)
ARL_2021 <-ARL_2021 %>%  mutate_all(as.factor)
ARL_2022 <-ARL_2022 %>%  mutate_all(as.factor)
ARL_2023 <-ARL_2023 %>%  mutate_all(as.factor)
ARL_total <-ARL_total %>%  mutate_all(as.factor)

```


convert dataframe to transaction format
```{r}

#2020
Cal2020tr <- ARL_2020 %>%
  unite(item, everything(), sep = ",")

write.csv(Cal2020tr, "C:/.../Cal2020tr.csv", quote = FALSE, row.names = FALSE)


#2021
Cal2021tr <- ARL_2021 %>%
  unite(item, everything(), sep = ",")

write.csv(Cal2021tr, "C:/.../Cal2021tr.csv", quote = FALSE, row.names = FALSE)


#2022
Cal2022tr <- ARL_2022 %>%
  unite(item, everything(), sep = ",")

write.csv(Cal2022tr, "C:/.../Cal2022tr.csv", quote = FALSE, row.names = FALSE)





#2023
Cal2023tr <- ARL_2023 %>%
  unite(item, everything(), sep = ",")

write.csv(Cal2023tr, "C:/.../Cal2023tr.csv", quote = FALSE, row.names = FALSE)


#Total
Caltottr <- ARL_total %>%
  unite(item, everything(), sep = ",")

write.csv(Caltottr, "C:/.../Caltottr.csv", quote = FALSE, row.names = FALSE)



```


Import transaction file
```{r}

tr2020 <- read.transactions("C:/.../Cal2020tr.csv", format = "basket", sep = ",")


tr2021 <- read.transactions("C:/.../Cal2021tr.csv", format = "basket", sep = ",")

tr2022 <- read.transactions("C:/.../Cal2022tr.csv", format = "basket", sep = ",")


tr2023 <- read.transactions("C:/.../Cal2023tr.csv", format = "basket", sep = ",")

trtot <- read.transactions("C:/.../Caltottr.csv", format = "basket", sep = ",")

```

Summary of transactions
```{r}

summary (tr2022)
summary (tr2023)

```


Absolute Item Frequency Plot
```{r}
itemFrequencyPlot(tr2022, topN = 20, type = "absolute", col = brewer.pal(8,'Pastel2'), main="Absolute Item Frequency Plot")
itemFrequencyPlot(tr2023, topN = 20, type = "absolute", col = brewer.pal(8,'Pastel2'), main="Absolute Item Frequency Plot")

```

Relative Item Frequency Plot
```{r}
itemFrequencyPlot(tr2022, topN = 20, type = "relative", col = brewer.pal(8,'Pastel2'), main="Relative Item Frequency Plot")
itemFrequencyPlot(tr2023, topN = 20, type = "relative", col = brewer.pal(8,'Pastel2'), main="Relative Item Frequency Plot")


```

Generating Rules (positive and negative)

```{r}

PP.association.rules <- apriori(trtot, parameter = list(supp=0.001, conf=0.001, maxlen=10),appearance = list(default="lhs",rhs="S+"))

NP.association.rules <- apriori(trtot, parameter = list(supp=0.001, conf=0.001, maxlen=10),appearance = list(default="lhs",rhs="S-"))

# PNP.association.rules <- apriori(trtot, parameter = list(supp=0.001, conf=0.001, maxlen=10),appearance = list(default="lhs",rhs= c ("S+","S-")))


```

Rules scatterplots
```{r}
plot(PP.association.rules)

```


Add supp_conf measure
```{r}

#Positive itemsets
Pquality_scores <- quality(PP.association.rules)

Psupp_conf <- Pquality_scores$support * Pquality_scores$confidence

slot(PP.association.rules, "quality")$supp_conf <- Psupp_conf
 
#Negative itemsets
Nquality_scores <- quality(NP.association.rules)

Nsupp_conf <- Nquality_scores$support * Nquality_scores$confidence

slot(NP.association.rules, "quality")$supp_conf <- Nsupp_conf





```


Filter rules with support and confidence thresholds 
(based on the quantile of generated rules)
```{r}

PsubRules<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 ]

NsubRules<- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 ]

# PNsubRules<- PNP.association.rules[quality(PNP.association.rules)$confidence > 0.8 & quality(PNP.association.rules)$support > 0.1 ]

```



Non-nested rules (general rules with different orders)
```{r}
PsubRules_Order<- PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 2 ]

NsubRules_Order<- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 2 ]


PO3 <- PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 3 ]

NO3 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 3 ]


PO4 <- PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 ]

NO4 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 ]



PO5 <- PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 5 ]

NO5 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 5 ]



PO6 <- PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 6 ]

NO6 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 6 ]



```


rules inspection and plots
```{r}
inspect(head(PsubRules_Order, n = 20, by = "confidence"))

plot((head(PO6, n = 10, by = "confidence")), method = "paracoord", measure = "confidence", shading = "lift")

```



Filter rules one Itemset and  confidence 
(supp and conf are added as filtering criteria in case we had different thresholds)
```{r}
PsubRules_Order<- PP.association.rules[quality(PP.association.rules)$confidence > 0.6 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 2 ]

NsubRules_Order<- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 2 ]

# PNsubRules_Order<- PNP.association.rules[quality(PNP.association.rules)$confidence > 0.8 & quality(PNP.association.rules)$support > 0.1 & size(PNP.association.rules) == 2 ]

```



rules inspection (ranked by confidence)
```{r}
NP_O2 <- c(PsubRules_Order,NsubRules_Order)

inspect(head(PsubRules_Order, n = 20, by = "confidence"))

inspect(head(NsubRules_Order, n = 20, by = "confidence"))

```


Exporting tables for first order rules
```{r}
xtable(inspect(head(PsubRules_Order, n = 20, by = "confidence")))

xtable(inspect(head(NsubRules_Order, n = 20, by = "confidence")))


```



selecting and combining top 10 rules
```{r}
Ptop10subRules <- head(PsubRules_Order, n = 10, by = "confidence")

Ntop10subRules <- head(NsubRules_Order, n = 10, by = "confidence")

NP10_O2 <- c(Ptop10subRules, Ntop10subRules)

```


Positive spreads plots for order 1 rules
```{r}

inspect(head(NsubRules_Order, n = 20, by = "confidence"))

plot(Ptop10subRules, method = "paracoord", measure = "support", shading = "confidence")

plot(NP_O2, method = "grouped", measure = "confidence", shading = "support")

plot(Ptop10subRules, method = "graph",  engine = "htmlwidget", measure = "confidence")

plot(Ptop10subRules, method = "graph",  engine = "ggplot2", measure = "confidence", color = 100)


```


Negative spreads plots for order 1 rules
```{r}

plot(Ntop10subRules, method = "paracoord", measure = "confidence", shading = "lift")

plot(Ntop10subRules, method = "grouped", measure = "confidence", shading = "lift")

plot(Ntop10subRules, method = "graph",  engine = "htmlwidget", measure = "confidence")

plot(Ntop10subRules, method = "graph",  engine = "ggplot2", measure = "confidence", color = 100)


```



Second order rules (nesting first order rules)

Filter rules  for positive 
```{r}

nested_rules_P <- c("Tax : FED TAXABLE/ST TAX-EXEMPT", 
                  "Pricing TYP : At Par", "CPN : 0_3(%)",
                  "R Ys to Maturity : Higher than 14.4", 
                  "Maturity OID : Higher than 17",
                  "S OID : Higher than 100", "DU_Adj_MID : Higher than 7",
                  "Y_OID : Higher than 3.2", "S OID : 57_100", "Maturity OID : 12.3_17","Call : Callable", "R Ys to Maturity : 9.4_14.4", "Y_OID : 2.4_3.2", "Issued Amt : Higher than 16")


PsubRules_Order3<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 3 & lhs(PP.association.rules) %in% nested_rules_P]

Ptop10subRules3 <- head(PsubRules_Order3, n = 10, by = "confidence")
```


Positive spreads plots for order 3 rules
```{r}

plot(Ptop10subRules3, method = "paracoord", measure = "support", shading = "confidence")

plot(Ptop10subRules3, method = "grouped", measure = "support", shading = "confidence")

plot(Ptop10subRules3, method = "graph",  engine = "htmlwidget", measure = "confidence")

plot(Ptop10subRules3, method = "graph",  engine = "ggplot2", measure = "confidence", color = 100)

inspect(head(Ptop10subRules3, n = 10, by = "confidence"))
```

Filter rules for Negative order 3
```{r}

nested_rules_N <- c("S OID : Less than 17", "Y_OID :  Less than 1.7", "Maturity OID :  Less than 8", "Call : Non-callable", "R Ys to Maturity :  Less than 4.7", "Maturity OID : 8_12.3", "R Ys to Maturity : 4.7_9.4", "DU_Adj_MID :  Less than 2.8", "S OID : 17_57","Pricing TYP : At Premium", "CPN : 5_8.5(%)", "Tax : FED & ST TAX-EXEMPT", "Issued Amt : Less than 14", "Muni Issued Size : 17_18.7")


NsubRules_Order3 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 3 & lhs(NP.association.rules) %in% nested_rules_N]

Ntop10subRules3 <- head(NsubRules_Order3, n = 10, by = "confidence")



```


Negative spreads plots for order 3 rules
```{r}

plot(Ntop10subRules3, method = "paracoord", measure = "support", shading = "confidence")

plot(Ntop10subRules3, method = "grouped", measure = "confidence", shading = "lift")

plot(Ntop10subRules3, method = "graph",  engine = "htmlwidget", measure = "confidence")

plot(Ntop10subRules3, method = "graph",  engine = "ggplot2", measure = "confidence", color = 100)

inspect(head(NsubRules_Order, n = 10, by = "confidence"))
```

positive rules (O3) inspection
```{r}
inspect(head(PsubRules_Order3, n = 10, by = "confidence"))

```

Order 4 rules for positive spreads
```{r}
nested_rules1 <- c("Tax : FED TAXABLE/ST TAX-EXEMPT", 
                  "Pricing TYP : At Par")
nested_rules2 <- c("Tax : FED TAXABLE/ST TAX-EXEMPT", "BB_rating : Not_Rated")

nested_rules3 <- c("Tax : FED TAXABLE/ST TAX-EXEMPT", "Market : REVENUE BONDS")

nested_rules4 <- c("Tax : FED TAXABLE/ST TAX-EXEMPT", "Self Rep. Gr. : YES")

nested_rules5 <- c("Market : REVENUE BONDS", "Pricing TYP : At Par")

nested_rules6 <- c("Pricing TYP : At Par", "Self Rep. Gr. : YES")

nested_rules7 <- c("S OID : Higher than 100", "Y_OID : Higher than 3.2")

nested_rules8 <- c("R Ys to Maturity : Higher than 14.4", "S OID : Higher than 100")

nested_rules9 <- c("BB_rating : Not_Rated", "S OID : Higher than 100")

nested_rules10 <- c("DU_Adj_MID : Higher than 7", "S OID : Higher than 100")

PsubRules_4Order_1<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules1 ]


PsubRules_4Order_2<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules2]

PsubRules_4Order_3<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules3]


PsubRules_4Order_4<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules4]


PsubRules_4Order_5<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules5]


PsubRules_4Order_6<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules6]


PsubRules_4Order_7<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules7]


PsubRules_4Order_8<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules8]


PsubRules_4Order_9<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules9]


PsubRules_4Order_10<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 4 & lhs(PP.association.rules) %ain% nested_rules10]


PsubRules_4Order <- unique(c(PsubRules_4Order_1, PsubRules_4Order_2, PsubRules_4Order_3, PsubRules_4Order_4, PsubRules_4Order_5, PsubRules_4Order_6, PsubRules_4Order_7, PsubRules_4Order_8, PsubRules_4Order_9, PsubRules_4Order_10))


```


Plot positive rules for order 4
```{r}

inspect(head(PsubRules_4Order, n = 10, by = "confidence"))

plot(PsubRules_4Order, method = "paracoord", measure = "support", shading = "confidence")

plot(PsubRules_4Order, method = "graph",  engine = "htmlwidget", measure = "confidence", shading = "lift")


```


```{r}
inspect(head(unique(Ntop10subRules3), n = 10, by = "confidence"))

```

Order 4 rules for Negative spreads
```{r}

nested_rules_N_1 <- c("Call : Non-callable", "Tax : FED & ST TAX-EXEMPT")

nested_rules_N_2 <- c("Call : Non-callable", "S OID : Less than 17")

nested_rules_N_3 <- c("Call : Non-callable", "Pricing TYP : At Premium")

nested_rules_N_4 <- c("FIN. TYP : NEW MONEY", "S OID : Less than 17")

nested_rules_N_5 <- c("R Ys to Maturity :  Less than 4.7", "Tax : FED & ST TAX-EXEMPT")

nested_rules_N_6 <- c("R Ys to Maturity :  Less than 4.7", "S OID : Less than 17")

nested_rules_N_7 <- c("Pricing TYP : At Premium", "R Ys to Maturity :  Less than 4.7")

nested_rules_N_8 <- c("Maturity OID :  Less than 8", "Tax : FED & ST TAX-EXEMPT")

nested_rules_N_9 <- c("Maturity OID :  Less than 8", "Pricing TYP : At Premium")

nested_rules_N_10 <- c("Maturity OID :  Less than 8", "S OID : Less than 17")


NsubRules_4Order_1 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_1]

NsubRules_4Order_2 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_2]


NsubRules_4Order_3 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_3]


NsubRules_4Order_4 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_4]

NsubRules_4Order_5 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_5]


NsubRules_4Order_6 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_6]


NsubRules_4Order_7 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_7]



NsubRules_4Order_8 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_8]


NsubRules_4Order_9 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_9]

NsubRules_4Order_10 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_10]

NsubRules_4Order <- unique(c(NsubRules_4Order_1, NsubRules_4Order_2, NsubRules_4Order_3, NsubRules_4Order_4, NsubRules_4Order_5, NsubRules_4Order_6, NsubRules_4Order_7, NsubRules_4Order_8, NsubRules_4Order_9, NsubRules_4Order_10))

Ntop10subRules_4Order <- head(NsubRules_4Order, n = 10, by = "confidence")

```

Plot negative rules order 4
```{r}

inspect(head(Ntop10subRules_4Order, n = 30, by = "confidence"))

plot(Ntop10subRules_4Order, method = "paracoord", measure = "support", shading = "confidence")

plot(Ntop10subRules_4Order, method = "graph",  engine = "htmlwidget", measure = "confidence", shading = "lift")


```

```{r}


inspect(head(PsubRules_4Order, n = 10, by = "confidence"))

```


Order 5 rules for positive spreads
```{r}
nested_rules1 <- c("Pricing TYP : At Par", 
                   "Self Rep. Gr. : YES", "Tax : FED TAXABLE/ST TAX-EXEMPT")

nested_rules2 <- c("Call : Callable", "R Ys to Maturity : Higher than 14.4", "S OID : Higher than 100")

nested_rules3 <- c("Call : Callable", "DU_Adj_MID : Higher than 7", "S OID : Higher than 100")


PsubRules_5Order_1<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 5 & lhs(PP.association.rules) %ain% nested_rules1 ]


PsubRules_5Order_2<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 5 & lhs(PP.association.rules) %ain% nested_rules2]

PsubRules_5Order_3<-PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & size(PP.association.rules) == 5 & lhs(PP.association.rules) %ain% nested_rules3]


PsubRules_5Order <- unique(c(PsubRules_5Order_1, PsubRules_5Order_2, PsubRules_5Order_3))


```


```{r}

inspect(head(PsubRules_5Order, n = 10, by = "confidence"))

plot(PsubRules_5Order, method = "paracoord", measure = "support", shading = "confidence")

plot(PsubRules_5Order, method = "graph",  engine = "htmlwidget", measure = "confidence", shading = "lift")

```


Order 4 rules for Negative spreads
```{r}

nested_rules_N_1 <- c("Call : Non-callable", "FIN. TYP : NEW MONEY", 
                      "S OID : Less than 17")

nested_rules_N_2 <- c("DU_Adj_MID :  Less than 2.8",
                      "R Ys to Maturity :  Less than 4.7", "Tax : FED & ST TAX-EXEMPT")

nested_rules_N_3 <- c("Call : Non-callable", "FIN. TYP : NEW MONEY",
                      "Tax : FED & ST TAX-EXEMPT")

nested_rules_N_4 <- c("Call : Non-callable", "CPN : 5_8.5(%)", "S OID : Less than 17")

nested_rules_N_5 <- c("DU_Adj_MID :  Less than 2.8", "Pricing TYP : At Premium",
                      "R Ys to Maturity :  Less than 4.7")

nested_rules_N_6 <- c("Call : Non-callable", "CPN : 5_8.5(%)", "Tax : FED & ST TAX-EXEMPT")

nested_rules_N_7 <- c("Call : Non-callable", "DU_Adj_MID :  Less than 2.8", "Tax : FED & ST TAX-EXEMPT")

nested_rules_N_8 <- c("Call : Non-callable", "Pricing TYP : At Premium", "Y_OID :  Less than 1.7")

nested_rules_N_9 <- c("Call : Non-callable", "S OID : Less than 17", "Tax : FED & ST TAX-EXEMPT")

nested_rules_N_10 <- c("Call : Non-callable", "Tax : FED & ST TAX-EXEMPT", "Y_OID :  Less than 1.7")


NsubRules_5Order_1 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_1]

NsubRules_5Order_2 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_2]


NsubRules_5Order_3 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_3]


NsubRules_5Order_4 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_4]

NsubRules_5Order_5 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_5]


NsubRules_5Order_6 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_6]


NsubRules_5Order_7 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_7]



NsubRules_5Order_8 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_8]


NsubRules_5Order_9 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_9]

NsubRules_5Order_10 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & size(NP.association.rules) == 4 & lhs(NP.association.rules) %in% nested_rules_N_10]

NsubRules_5Order <- unique(c(NsubRules_5Order_1, NsubRules_5Order_2, NsubRules_5Order_3, NsubRules_5Order_4, NsubRules_5Order_5, NsubRules_5Order_6, NsubRules_5Order_7, NsubRules_5Order_8, NsubRules_5Order_9, NsubRules_5Order_10))

Ntop10subRules_5Order <- head(NsubRules_5Order, n = 10, by = "confidence")

```


```{r}

inspect(head(Ntop10subRules_5Order, n = 10, by = "confidence"))

plot(Ntop10subRules_5Order, method = "paracoord", measure = "support", shading = "confidence")

plot(Ntop10subRules_5Order, method = "graph",  engine = "htmlwidget", measure = "confidence", shading = "lift")
```

Condition on specific attributes



Conditioning on Structuring attributes 
```{r}

#Callability

Con.rules.call_Pos <- PP.association.rules[quality(PP.association.rules)$confidence > 0.65 & quality(PP.association.rules)$support > 0.1 & lhs(PP.association.rules) %ain% c("Call : Callable")& size(PP.association.rules) == 3]


Con.rules.noncall_Pos <- PP.association.rules[quality(PP.association.rules)$confidence > 0.01 & quality(PP.association.rules)$support > 0.01 & lhs(PP.association.rules) %ain% c("Call : Non-callable")& size(PP.association.rules) == 3]


Con.rules.call_Neg <- NP.association.rules[quality(NP.association.rules)$confidence > 0.01 & quality(NP.association.rules)$support > 0.01 & lhs(NP.association.rules) %ain% c("Call : Callable")& size(NP.association.rules) == 3]

Con.rules.noncall_Neg <- NP.association.rules[quality(NP.association.rules)$confidence > 0.45 & quality(NP.association.rules)$support > 0.1 & lhs(NP.association.rules) %ain% c("Call : Non-callable")& size(NP.association.rules) == 3]

inspect(head(Con.rules.noncall_Neg, n = 10, by = "supp_conf"))


#Tax 

Con.rules.fedTax_Pos <- PP.association.rules[quality(PP.association.rules)$confidence > 0.01 & quality(PP.association.rules)$support > 0.01 & lhs(PP.association.rules) %ain% c("Tax : FED TAXABLE/ST TAX-EXEMPT")& size(PP.association.rules) == 3]


Con.rules.taxexemp_Pos <- PP.association.rules[quality(PP.association.rules)$confidence > 0.01 & quality(PP.association.rules)$support > 0.01 & lhs(PP.association.rules) %ain% c("Tax : FED & ST TAX-EXEMPT")& size(PP.association.rules) == 3]


Con.rules.fedTax_Neg <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Tax : FED TAXABLE/ST TAX-EXEMPT")& size(NP.association.rules) == 3]

Con.rules.taxexemp_Neg <- NP.association.rules[quality(NP.association.rules)$confidence > 0.01 & quality(NP.association.rules)$support > 0.1 & lhs(NP.association.rules) %ain% c("Tax : FED & ST TAX-EXEMPT")& size(NP.association.rules) == 3]




#combined

# Con.rules.com_Neg <- NP.association.rules[quality(NP.association.rules)$confidence > 0.01 & quality(NP.association.rules)$support > 0.01 & lhs(NP.association.rules) %ain% c("Call : Non-callable", "Tax : FED & ST TAX-EXEMPT") & size(NP.association.rules) == 5]
# 
# 
# Con.rules.com_Pos <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Call : Non-callable", "Tax : FED & ST TAX-EXEMPT") & size(PP.association.rules) == 5]
# 
# 
# Con.rules.UOP_Neg_2 <- NP.association.rules[quality(NP.association.rules)$confidence > 0.0001 & quality(NP.association.rules)$support > 0.0001 & lhs(NP.association.rules) %ain% c("Call : Callable", "Tax : FED TAXABLE/ST TAX-EXEMPT") & size(NP.association.rules) == 5]




#plot
plot(head(Con.rules.fedTax_Neg, n = 10, by = "supp_conf"), method = "graph",  engine = "htmlwidget", shading = "supp_conf")



```


Conditioning on Issuer sector
```{r}


#Sector positive rules


power_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Issuer Sector : Power")& size(PP.association.rules) == 3]

Utilities_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Issuer Sector : Utilities") & size(PP.association.rules) == 3]


General_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Issuer Sector : General") & size(PP.association.rules) == 3]

General_obl_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Issuer Sector : General Obligation") & size(PP.association.rules) == 3]


Mello_Roos_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.01 & quality(PP.association.rules)$support > 0.01 & lhs(PP.association.rules) %ain% c("Issuer Sector : Mello-Roos") & size(PP.association.rules) == 3]


Pollution_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Issuer Sector : Pollution") & size(PP.association.rules) == 3]


School_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Issuer Sector : School District") & size(PP.association.rules) == 3]


Water_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Issuer Sector : Water") & size(PP.association.rules) == 3]


Airport_sec_p <- PP.association.rules[quality(PP.association.rules)$confidence > 0.001 & quality(PP.association.rules)$support > 0.001 & lhs(PP.association.rules) %ain% c("Issuer Sector : Airport") & size(PP.association.rules) == 3]




issuer_sec_p <- c(head(power_sec_p, n = 5, by = "supp_conf"),
                head(Utilities_sec_p, n = 5, by = "supp_conf"),
                head(General_sec_p, n = 5, by = "supp_conf"),
                head(General_obl_sec_p, n = 5, by = "supp_conf"),
                head(Mello_Roos_sec_p, n = 5, by = "supp_conf"),
                head(Pollution_sec_p, n = 5, by = "supp_conf"),
                head(School_sec_p, n = 5, by = "supp_conf"),
                head(Water_sec_p, n = 5, by = "supp_conf"),
                head(Airport_sec_p, n = 5, by = "supp_conf")
                )




#Sector Negative rules



power_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : Power")& size(NP.association.rules) == 3]

Utilities_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : Utilities") & size(NP.association.rules) == 3]


General_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : General") & size(NP.association.rules) == 3]

General_obl_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : General Obligation") & size(NP.association.rules) == 3]


Mello_Roos_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : Mello-Roos") & size(NP.association.rules) == 3]


Pollution_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : Pollution") & size(NP.association.rules) == 3]


School_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : School District") & size(NP.association.rules) == 3]


Water_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : Water") & size(NP.association.rules) == 3]


Airport_sec_n <- NP.association.rules[quality(NP.association.rules)$confidence > 0.001 & quality(NP.association.rules)$support > 0.001 & lhs(NP.association.rules) %ain% c("Issuer Sector : Airport") & size(NP.association.rules) == 3]




issuer_sec_n <- c(head(power_sec_n, n = 5, by = "supp_conf"),
                head(Utilities_sec_n, n = 5, by = "supp_conf"),
                head(General_sec_n, n = 5, by = "supp_conf"),
                head(General_obl_sec_n, n = 5, by = "supp_conf"),
                head(Mello_Roos_sec_n, n = 5, by = "supp_conf"),
                head(Pollution_sec_n, n = 5, by = "supp_conf"),
                head(School_sec_n, n = 5, by = "supp_conf"),
                head(Water_sec_n, n = 5, by = "supp_conf"),
                head(Airport_sec_n, n = 5, by = "supp_conf")
                )







```



```{r}

plot(head(issuer_sec_p, n = 100, by = "supp_conf"), method = "graph",  engine = "htmlwidget", shading = "supp_conf")

plot(issuer_sec_p, method = "paracoord", measure = "support", shading = "confidence")

plot(head(issuer_sec_n, n = 100, by = "supp_conf"), method = "graph",  engine = "htmlwidget", shading = "supp_conf")

plot(issuer_sec_n, method = "paracoord", measure = "support", shading = "confidence")

inspect(head(Utilities_sec_p, n = 30, by = "supp_conf"))

```

Conditioning on UOP
```{r}
#Positive rules

#UOP : ELEC. LT. & PWR. IMPTS.

ELEC_LT_PWR_IMPTS_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : ELEC. LT. & PWR. IMPTS.") & 
  size(PP.association.rules) == 3]


#UOP : TRANSIT IMPS.

TRANSIT_IMPS_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : TRANSIT IMPS.") & 
  size(PP.association.rules) == 3]


# UOP: ADVANCE REFUNDING
ADVANCE_REFUNDING_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.01 & 
  quality(PP.association.rules)$support > 0.01 & 
  lhs(PP.association.rules) %ain% c("UOP : ADVANCE REFUNDING") & 
  size(PP.association.rules) == 3]

# UOP: CURRENT REFUNDING
CURRENT_REFUNDING_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : CURRENT REFUNDING") & 
  size(PP.association.rules) == 3]

# UOP: GREEN PURPOSE
GREEN_PURPOSE_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : GREEN PURPOSE") & 
  size(PP.association.rules) == 3]


# UOP: PUBLIC FACILITIES
PUBLIC_FACILITIES_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : PUBLIC FACILITIES") & 
  size(PP.association.rules) == 3]

# UOP: PUBLIC IMPS.
PUBLIC_IMPS_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : PUBLIC IMPS.") & 
  size(PP.association.rules) == 3]

# UOP: RECREATIONAL FAC. IMPS.
RECREATIONAL_FAC_IMPS_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : RECREATIONAL FAC. IMPS.") & 
  size(PP.association.rules) == 3]

# UOP: REFUNDING NOTES
REFUNDING_NOTES_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : REFUNDING NOTES") & 
  size(PP.association.rules) == 3]

# UOP: SCHOOL IMPS.
SCHOOL_IMPS_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : SCHOOL IMPS.") & 
  size(PP.association.rules) == 3]

# UOP: SEWER IMPS.
SEWER_IMPS_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : SEWER IMPS.") & 
  size(PP.association.rules) == 3]

# UOP: WATER UTILITY IMPS.
WATER_UTILITY_IMPS_uop_p <- PP.association.rules[
  quality(PP.association.rules)$confidence > 0.001 & 
  quality(PP.association.rules)$support > 0.001 & 
  lhs(PP.association.rules) %ain% c("UOP : WATER UTILITY IMPS.") & 
  size(PP.association.rules) == 3]


UOP_p <- c(
  head(ADVANCE_REFUNDING_uop_p, n = 5, by = "supp_conf"),
  head(CURRENT_REFUNDING_uop_p, n = 5, by = "supp_conf"),
  head(GREEN_PURPOSE_uop_p, n = 5, by = "supp_conf"),
  head(PUBLIC_FACILITIES_uop_p, n = 5, by = "supp_conf"),
  head(PUBLIC_IMPS_uop_p, n = 5, by = "supp_conf"),
  head(RECREATIONAL_FAC_IMPS_uop_p, n = 5, by = "supp_conf"),
  head(REFUNDING_NOTES_uop_p, n = 5, by = "supp_conf"),
  head(SCHOOL_IMPS_uop_p, n = 5, by = "supp_conf"),
  head(SEWER_IMPS_uop_p, n = 5, by = "supp_conf"),
  head(WATER_UTILITY_IMPS_uop_p, n = 5, by = "supp_conf"),
  head(ELEC_LT_PWR_IMPTS_uop_p, n = 5, by = "supp_conf"),
  head(TRANSIT_IMPS_uop_p, n = 5, by = "supp_conf")
)




#Negative rules


# UOP: ELEC. LT. & PWR. IMPTS.
ELEC_LT_PWR_IMPTS_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : ELEC. LT. & PWR. IMPTS.") & 
  size(NP.association.rules) == 3]

# UOP: TRANSIT IMPS.
TRANSIT_IMPS_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : TRANSIT IMPS.") & 
  size(NP.association.rules) == 3]


# UOP: ADVANCE REFUNDING
ADVANCE_REFUNDING_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : ADVANCE REFUNDING") & 
  size(NP.association.rules) == 3]

# UOP: CURRENT REFUNDING
CURRENT_REFUNDING_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : CURRENT REFUNDING") & 
  size(NP.association.rules) == 3]

# UOP: GREEN PURPOSE
GREEN_PURPOSE_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : GREEN PURPOSE") & 
  size(NP.association.rules) == 3]

# UOP: PUBLIC FACILITIES
PUBLIC_FACILITIES_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : PUBLIC FACILITIES") & 
  size(NP.association.rules) == 3]

# UOP: PUBLIC IMPS.
PUBLIC_IMPS_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : PUBLIC IMPS.") & 
  size(NP.association.rules) == 3]

# UOP: RECREATIONAL FAC. IMPS.
RECREATIONAL_FAC_IMPS_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : RECREATIONAL FAC. IMPS.") & 
  size(NP.association.rules) == 3]

# UOP: REFUNDING NOTES
REFUNDING_NOTES_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : REFUNDING NOTES") & 
  size(NP.association.rules) == 3]

# UOP: SCHOOL IMPS.
SCHOOL_IMPS_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : SCHOOL IMPS.") & 
  size(NP.association.rules) == 3]

# UOP: SEWER IMPS.
SEWER_IMPS_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : SEWER IMPS.") & 
  size(NP.association.rules) == 3]

# UOP: WATER UTILITY IMPS.
WATER_UTILITY_IMPS_uop_n <- NP.association.rules[
  quality(NP.association.rules)$confidence > 0.001 & 
  quality(NP.association.rules)$support > 0.001 & 
  lhs(NP.association.rules) %ain% c("UOP : WATER UTILITY IMPS.") & 
  size(NP.association.rules) == 3]


UOP_n <- c(
  head(ADVANCE_REFUNDING_uop_n, n = 5, by = "supp_conf"),
  head(CURRENT_REFUNDING_uop_n, n = 5, by = "supp_conf"),
  head(GREEN_PURPOSE_uop_n, n = 5, by = "supp_conf"),
  head(PUBLIC_FACILITIES_uop_n, n = 5, by = "supp_conf"),
  head(PUBLIC_IMPS_uop_n, n = 5, by = "supp_conf"),
  head(RECREATIONAL_FAC_IMPS_uop_n, n = 5, by = "supp_conf"),
  head(REFUNDING_NOTES_uop_n, n = 5, by = "supp_conf"),
  head(SCHOOL_IMPS_uop_n, n = 5, by = "supp_conf"),
  head(SEWER_IMPS_uop_n, n = 5, by = "supp_conf"),
  head(WATER_UTILITY_IMPS_uop_n, n = 5, by = "supp_conf"),
  head(ELEC_LT_PWR_IMPTS_uop_n, n = 5, by = "supp_conf"),
  head(TRANSIT_IMPS_uop_n, n = 5, by = "supp_conf")
)



```

```{r}
plot(head(UOP_n, n = 100, by = "supp_conf"), method = "graph",  engine = "htmlwidget", shading = "supp_conf")

plot(UOP_p, method = "paracoord", measure = "support", shading = "confidence")

plot(head(UOP_n, n = 100, by = "supp_conf"), method = "graph",  engine = "htmlwidget", shading = "supp_conf")

plot(UOP_n, method = "paracoord", measure = "support", shading = "confidence")


inspect(head(TRANSIT_IMPS_uop_p, n = 30, by = "supp_conf"))

```



```{r}

#Iss. Sect

#UOP_positive rules
Con.rules.UOP_Pos <- PP.association.rules[quality(PP.association.rules)$confidence > 0.01 & quality(PP.association.rules)$support > 0.01 & lhs(PP.association.rules) %pin% "UOP : "  ]

Con.rules.UOP_Neg <- NP.association.rules[quality(NP.association.rules)$confidence > 0.01 & quality(NP.association.rules)$support > 0.01 & lhs(NP.association.rules) %pin% "UOP : "  ]

Con.rules.Sec_P <- PP.association.rules[quality(PP.association.rules)$confidence > 0.01 & quality(PP.association.rules)$support > 0.01 & lhs(PP.association.rules) %pin% "Issuer Sector : "  ]

Con.rules.Sec_N <- NP.association.rules[quality(NP.association.rules)$confidence > 0.01 & quality(NP.association.rules)$support > 0.01 & lhs(NP.association.rules) %pin% "Issuer Sector : "  ]
```

Stack barchart for attribute frequency for positive rules
```{r}
sectors <- c(
  "Issuer Sector : General",
  "Issuer Sector : Water",
  "Issuer Sector : General Obligation",
  "Issuer Sector : School District",
  "Issuer Sector : Power",
  "Issuer Sector : Pollution",
  "Issuer Sector : Utilities",
  "Issuer Sector : Mello-Roos"
)

plots <- list()

for (sector in sectors) {
  sector_rules_n <- PP.association.rules[
    quality(PP.association.rules)$confidence > 0.001 &
      quality(PP.association.rules)$support > 0.001 &
      lhs(PP.association.rules) %ain% sector
  ]
 
  # Convert to transactions
  lhs_items <- as(lhs(sector_rules_n), "transactions")
 
  # Calculate item frequencies
  item_freq <- itemFrequency(lhs_items)
 
  # Create data frame
  item_freq_df <- data.frame(attribute_category = names(item_freq), frequency = item_freq, row.names = NULL) %>%
    filter(!(frequency %in% c(0.000, 1.00)))  %>%
    mutate(
      attribute = sapply(strsplit(attribute_category, " : "), `[`, 1),
      category = sapply(strsplit(attribute_category, " : "), `[`, 2)
    ) %>%
    group_by(attribute) %>%
    mutate(aggregated_frequency = sum(frequency)) %>%
    arrange(desc(aggregated_frequency)) %>%
    ungroup() %>%
    mutate(attribute_category = fct_reorder(attribute_category, frequency, .fun = min))
  
  
  item_freq_df <- item_freq_df %>% filter(!(attribute %in% c("Issuer Name", "UOP")) & !(attribute_category %in% c("Tax : AMT/ST TAX-EXEMPT", "Tax : FED TAXABLE", "Tax : FED BQ/ST TAX-EXEMPT", "Tax : FED TAX-EXEMPT", "Tax : FED TAXABLE/ST TAXABLE" )))
  
  
  item_freq_df_top10 <- item_freq_df %>%
  distinct(attribute, .keep_all = TRUE) %>%
  arrange(desc(aggregated_frequency)) %>%
  head(10) %>% select(attribute)
  
  item_freq_df_final <- item_freq_df %>% filter(attribute %in% item_freq_df_top10$attribute)
  
 
  # Create plot with single color and correct stacking order
  plot <- ggplot(item_freq_df_final, aes(x = frequency, y = fct_reorder(attribute, aggregated_frequency), group = attribute_category)) +
    geom_bar(stat = "identity", position = "stack", width = 0.6, color = "black", fill = "skyblue") +
    geom_text(aes(label = category),
              position = position_stack(vjust = 0.5), color = "black", size = 3, hjust = 0.5) +
    labs(x = "Frequency", y = "Attribute") +
    theme_minimal() +
    theme(axis.text.y = element_text(hjust = 0),
          panel.border = element_rect(color = "black", fill = NA, linewidth = 1))
 
 
  plots[[sector]] <- plot
}

# Plot for each sector
for (i in 1:length(plots)) {
  print(plots[[i]])
}


```




Stack bar chart for attributes frequency (Negative)

```{r}


sectors <- c(
  "Issuer Sector : General",
  "Issuer Sector : Water",
  "Issuer Sector : General Obligation",
  "Issuer Sector : School District",
  "Issuer Sector : Power",
  "Issuer Sector : Pollution",
  "Issuer Sector : Utilities",
  "Issuer Sector : Mello-Roos"
)

plots <- list()

for (sector in sectors) {
  sector_rules_n <- NP.association.rules[
    quality(NP.association.rules)$confidence > 0.001 &
      quality(NP.association.rules)$support > 0.001 &
      lhs(NP.association.rules) %ain% sector
  ]
 
  # Convert to transactions
  lhs_items <- as(lhs(sector_rules_n), "transactions")
 
  # Calculate item frequencies
  item_freq <- itemFrequency(lhs_items)
 
  # Create data frame
  item_freq_df <- data.frame(attribute_category = names(item_freq), frequency = item_freq, row.names = NULL) %>%
    filter(!(frequency %in% c(0.000, 1.00)))  %>%
    mutate(
      attribute = sapply(strsplit(attribute_category, " : "), `[`, 1),
      category = sapply(strsplit(attribute_category, " : "), `[`, 2)
    ) %>%
    group_by(attribute) %>%
    mutate(aggregated_frequency = sum(frequency)) %>%
    arrange(desc(aggregated_frequency)) %>%
    ungroup() %>%
    mutate(attribute_category = fct_reorder(attribute_category, frequency, .fun = min))
  
  
  item_freq_df <- item_freq_df %>% filter(!(attribute %in% c("Issuer Name", "UOP")) )
  
  
  item_freq_df_top10 <- item_freq_df %>%
  distinct(attribute, .keep_all = TRUE) %>%
  arrange(desc(aggregated_frequency)) %>%
  head(10) %>% select(attribute)
  
  item_freq_df_final <- item_freq_df %>% filter(attribute %in% item_freq_df_top10$attribute)
  
 
  # Create plot with single color and correct stacking order
  plot <- ggplot(item_freq_df_final, aes(x = frequency, y = fct_reorder(attribute, aggregated_frequency), group = attribute_category)) +
    geom_bar(stat = "identity", position = "stack", width = 0.6, color = "black", fill = "skyblue") +
    geom_text(aes(label = category),
              position = position_stack(vjust = 0.5), color = "black", size = 3, hjust = 0.5) +
    labs(x = "Frequency", y = "Attribute") +
    theme_minimal() +
    theme(axis.text.y = element_text(hjust = 0),
          panel.border = element_rect(color = "black", fill = NA, linewidth = 1))
 
 
  plots[[sector]] <- plot
}

# Plot for each sector
for (i in 1:length(plots)) {
  print(plots[[i]])
}


```




UOP for sectors

```{r}




uop_colors <- c(
  "ADVANCE REFUNDING" = "#1f77b4",
  "CIVIC CONVENTION CENTER" = "#ff7f0e",
  "CURRENT REFUNDING" = "skyblue",
  "ELEC. LT. & PWR. IMPTS." = "#d62728",
  "GREEN PURPOSE" = "darkgreen",
  "HLTH- HOSP- NURSHOME IMPS" = "#8c564b",
  "INDUSTRIAL IMPS." = "#e377c2",
  "MISC. PURPOSES" = "#7f7f7f",
  "NURSING HOMES" = "#bcbd22",
  "PARKING FACILITY IMPS." = "#17becf",
  "PRT- AIRPRT & MARINA IMPS" = "#1f77b4",
  "PUBLIC FACILITIES" = "gold",
  "PUBLIC IMPS." = "#2ca02c",
  "RECREATIONAL FAC. IMPS." = "#d62728",
  "REFUNDING BONDS" = "#9467bd",
  "REFUNDING NOTES" = "brown",
  "REPAYMENT OF BANK LOAN" = "#e377c2",
  "RESOURCE RECOVERY IMPS." = "#7f7f7f",
  "SCHOOL IMPS." = "#bcbd22",
  "SEWER IMPS." = "darkblue",
  "STATE MF HSG" = "#1f77b4",
  "STUDENT HOUSING" = "#ff7f0e",
  "TRANSIT IMPS." = "green",
  "UNIV. & COLLEGE IMPS." = "black",
  "WATER UTILITY IMPS." = "grey"
)


sectors <- c(
  "Issuer Sector : General",
  "Issuer Sector : Water",
  "Issuer Sector : General Obligation",
  "Issuer Sector : School District",
  "Issuer Sector : Power",
  "Issuer Sector : Pollution",
  "Issuer Sector : Utilities",
  "Issuer Sector : Mello-Roos"
)

for (sector in sectors) {
  sector_rules_p <- PP.association.rules[
    quality(PP.association.rules)$confidence > 0.001 &
      quality(PP.association.rules)$support > 0.001 &
      lhs(PP.association.rules) %ain% c(sector)
  ]
  
  sector_rules_n <- NP.association.rules[
    quality(NP.association.rules)$confidence > 0.001 &
      quality(NP.association.rules)$support > 0.001 &
      lhs(NP.association.rules) %ain% c(sector)
  ]
  
  lhs_items_p <- as(lhs(sector_rules_p), "transactions")
  lhs_items_n <- as(lhs(sector_rules_n), "transactions")
  
  item_freq_p <- itemFrequency(lhs_items_p)
  item_freq_n <- itemFrequency(lhs_items_n)
  
  attr_names_p <- strsplit(names(item_freq_p[grep("^UOP : ", names(item_freq_p))]), " : ")
  attr_names_n <- strsplit(names(item_freq_n[grep("^UOP : ", names(item_freq_n))]), " : ")
  
  Sec_UOP_p <- data.frame(UOP = sapply(attr_names_p, `[`, 2),
                          frequency = as.vector(item_freq_p[grep("^UOP : ", names(item_freq_p))])) %>%
    filter(!(frequency == 0.000000)) %>%
    mutate(Spread = "S(+)")
  
  Sec_UOP_n <- data.frame(UOP = sapply(attr_names_n, `[`, 2),
                          frequency = as.vector(item_freq_n[grep("^UOP : ", names(item_freq_n))])) %>%
    filter(!(frequency == 0.000000)) %>%
    mutate(Spread = "S(-)")
  
  Sec_UOP_pn <- rbind(Sec_UOP_p, Sec_UOP_n) %>% filter(UOP %in% c(
  "GREEN PURPOSE",
  "CURRENT REFUNDING",
  "WATER UTILITY IMPS.",
  "ADVANCE REFUNDING",
  "TRANSIT IMPS.",
  "PUBLIC IMPS.",
  "SCHOOL IMPS.",
  "PUBLIC FACILITIES",
  "REFUNDING NOTES",
  "SEWER IMPS.",
  "ELEC. LT. & PWR. IMPTS.",
  "RECREATIONAL FAC. IMPS."
)  )
  
  print(
    ggplot(Sec_UOP_pn, aes(x = Spread, y = frequency, fill = UOP)) +
      geom_bar(stat = "identity", position = "stack", width = 0.6, color = "black") +
      geom_text(aes(label = sprintf("%.2f", frequency), y = frequency),
                position = position_stack(vjust = 0.5), color = "white", size = 3) +
      scale_fill_manual(values = uop_colors) +  # Assigning colors
      labs(x = "Spread", y = "Frequency") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            panel.border = element_rect(color = "black", fill = NA, linewidth = 1))
  )
}

```

